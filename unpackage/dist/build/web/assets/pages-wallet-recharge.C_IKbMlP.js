import{s as e,z as t,A as n,B as s,p as c,c as a,w as o,i as r,o as l,e as i,f as u,h,t as d,C as g,q as f,v as m,F as C,l as w,k as p,I as S,j as T}from"./index-D2V8Eyea.js";import{N as D}from"./NavBar.Clp1va3T.js";import{g as A,a as U,w as y,b as B}from"./wallet-manager.DtY3I8Qk.js";import{_}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./right.CKag88Jh.js";const k=""+new URL("chongzhi-BNPDWex-.png",import.meta.url).href;const v=_({name:"Recharge",components:{NavBar:D},data:()=>({rechargeAmount:"",currentBalance:0,presetAmounts:[10,30,50,100,200],walletConnected:!1,walletAddress:"",contractConfig:null,currentNetwork:"MAINNET",refreshing:!1}),computed:{canRecharge(){const e=parseFloat(this.rechargeAmount);return e>=10&&e>0&&this.walletConnected}},onLoad(){console.log("充值页面加载"),this.initContractConfig(),this.checkWalletStatus()},onShow(){console.log("充值页面显示"),this.checkWalletStatus()},methods:{initContractConfig(){try{this.currentNetwork=A(),this.contractConfig=U(),console.log("合约配置初始化",this.contractConfig)}catch(t){console.error("初始化合约配置失败",t),e({title:"合约配置初始化失败",icon:"none"})}},async checkWalletStatus(){try{const e=await y.getNetworkInfo();console.log("充值页面检查钱包状态",e),e.isConnected&&e.account?(this.walletConnected=!0,this.walletAddress=e.account,await this.loadCurrentBalance()):(this.walletConnected=!1,this.walletAddress="",this.currentBalance=0)}catch(e){console.error("检查钱包状态失败",e),this.walletConnected=!1,this.walletAddress="",this.currentBalance=0}},async loadCurrentBalance(){try{if(!this.walletConnected)return void(this.currentBalance=0);console.log("开始加载USDT余额...");const e=await y.getUSDTBalance(this.walletAddress);console.log("USDT余额查询结果:",e),e.success?(this.currentBalance=e.balance,console.log("USDT余额加载成功:",this.currentBalance)):(console.warn("USDT余额加载失败:",e.error),this.currentBalance=0,e.debug&&console.warn("USDT余额查询调试信息:",e.debug))}catch(e){console.error("加载USDT余额失败:",e),this.currentBalance=0}},async refreshBalance(){if(this.walletConnected){this.refreshing=!0;try{await this.loadCurrentBalance(),e({title:"余额已刷新",icon:"success"})}catch(t){e({title:"刷新失败",icon:"none"})}finally{this.refreshing=!1}}else e({title:"请先连接钱包",icon:"none"})},formatBalance:e=>"number"!=typeof e||isNaN(e)?"0.00":e.toFixed(2),selectPresetAmount(e){this.rechargeAmount=e.toString()},onAmountInput(e){const t=e.detail.value;this.rechargeAmount=t.replace(/[^\d.]/g,"")},handleRecharge(){if(!this.walletConnected)return void e({title:"请先连接钱包",icon:"none"});const n=parseFloat(this.rechargeAmount);t({title:"确认充值",content:`确认充值 ${n} USDT 吗？\n\n注意：\n1. 充值将发送USDT代币到合约地址\n2. 需要ETH/BNB支付gas费\n3. 请确保网络稳定`,success:e=>{e.confirm&&this.processRecharge(n)}})},async processRecharge(c){n({title:"充值中..."});try{if(!y.currentService)throw new Error("钱包服务未初始化，请重新连接钱包");const n=await y.getNetworkInfo();if(!n.isConnected||!n.account)throw new Error("钱包未连接，请先连接钱包");if(!this.contractConfig)throw new Error("充值合约未配置，请联系管理员");console.log("开始充值流程，金额:",c,"USDT"),console.log("使用合约:","0xdAC17F958D2ee523a2206206994597C13D831ec7"),console.log("当前网络:",this.currentNetwork);const a=await this.callRechargeContract(c);if(!a.success)throw new Error(a.error||"充值失败");s(),e({title:"充值成功",icon:"success"}),this.rechargeAmount="",await this.loadCurrentBalance(),setTimeout((()=>{t({title:"USDT充值成功",content:`成功充值 ${c} USDT\n\n交易哈希: ${a.txHash}\n\nUSDT合约: ${a.contractAddress}\n\n网络: ${this.contractConfig.networkName}\n\n余额已更新`,showCancel:!1,success:()=>{}})}),1e3)}catch(a){s(),e({title:a.message||"充值失败，请重试",icon:"none"}),console.error("充值失败:",a)}},async callRechargeContract(e){try{console.log("调用USDT代币转账开始");const t=U(),n=B();console.log("充值合约配置:",t),console.log("USDT合约配置:",n);const s=t.address;console.log("使用充值合约地址:",s);const c=await y.sendUSDTTransaction(s,e);return console.log("USDT代币转账结果:",c),c.success?{success:!0,txHash:c.txHash,message:"USDT代币转账成功",contractAddress:c.contractAddress,amount:c.amount,decimals:c.decimals,rechargeContractAddress:s}:{success:!1,error:c.error||"USDT代币转账失败"}}catch(t){return console.error("调用USDT代币转账失败:",t),{success:!1,error:t.message||"USDT代币转账失败"}}},buildContractCallData(e){try{const t="recharge(uint256)";return console.log("构建合约调用数据:",{method:t,amount:e,contractAddress:"0xdAC17F958D2ee523a2206206994597C13D831ec7"}),{method:t,amount:e,contractAddress:"0xdAC17F958D2ee523a2206206994597C13D831ec7"}}catch(t){throw console.error("构建合约调用数据失败:",t),new Error("USDT转账数据构建失败")}},goToConnect(){this.connectWallet()},async connectWallet(){console.log("开始连接钱包");try{n({title:"连接中..."}),console.log("钱包管理器状态",{currentService:y.currentService,serviceType:y.serviceType,isConnected:y.isConnected});const c=await y.connectWallet();s(),c.success?(e({title:"钱包连接成功",icon:"success"}),await this.checkWalletStatus(),console.log("连接后钱包管理器状态",{currentService:y.currentService,serviceType:y.serviceType,isConnected:y.isConnected})):(e({title:c.error||"连接失败",icon:"none"}),c.suggestions&&setTimeout((()=>{t({title:"连接失败",content:c.suggestions,showCancel:!1})}),1e3))}catch(c){s(),console.error("连接钱包失败:",c),e({title:"连接失败，请重试",icon:"none"})}}}},[["render",function(e,t,n,s,D,A){const U=c("NavBar"),y=w,B=p,_=r,v=S,b=T;return l(),a(_,{class:"recharge-page"},{default:o((()=>[i(U,{title:"充值"}),D.walletConnected?h("",!0):(l(),a(_,{key:0,class:"connection-notice"},{default:o((()=>[i(y,{class:"notice-text"},{default:o((()=>[u("钱包未连接")])),_:1}),i(B,{class:"connect-btn",onClick:A.goToConnect},{default:o((()=>[u("连接钱包")])),_:1},8,["onClick"])])),_:1})),i(_,{class:"main-content"},{default:o((()=>[i(_,{class:"input-section"},{default:o((()=>[i(y,{class:"input-label"},{default:o((()=>[u("请填写数量")])),_:1}),i(_,{class:"amount-input"},{default:o((()=>[i(y,{class:"currency-symbol"},{default:o((()=>[u("$")])),_:1}),i(v,{class:"amount-field",type:"number",modelValue:D.rechargeAmount,"onUpdate:modelValue":t[0]||(t[0]=e=>D.rechargeAmount=e),placeholder:"0.00",onInput:A.onAmountInput},null,8,["modelValue","onInput"])])),_:1}),i(_,{class:"input-line"})])),_:1}),i(_,{class:"balance-info"},{default:o((()=>[i(y,{class:"balance-text"},{default:o((()=>[u("当前余额: "+d(A.formatBalance(D.currentBalance))+" USDT",1)])),_:1}),i(_,{class:g(["refresh-btn",{refreshing:D.refreshing}]),onClick:A.refreshBalance},{default:o((()=>[i(y,{class:"refresh-text"},{default:o((()=>[u(d(D.refreshing?"刷新中...":"刷新"),1)])),_:1})])),_:1},8,["onClick","class"])])),_:1}),i(_,{class:"min-amount-notice"},{default:o((()=>[i(y,{class:"notice-text"},{default:o((()=>[u("*最低10 USDT")])),_:1})])),_:1}),i(_,{class:"preset-amounts"},{default:o((()=>[(l(!0),f(C,null,m(D.presetAmounts,(e=>(l(),a(_,{class:g(["preset-btn",{active:D.rechargeAmount==e}]),key:e,onClick:t=>A.selectPresetAmount(e)},{default:o((()=>[i(y,{class:"preset-text"},{default:o((()=>[u(d(e)+" USDT",1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1}),i(_,{class:"recharge-section"},{default:o((()=>[i(b,{class:g(["recharge-btn",{disabled:!A.canRecharge}]),src:k,onClick:A.handleRecharge},null,8,["onClick","class"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-df2b58e2"]]);export{v as default};
