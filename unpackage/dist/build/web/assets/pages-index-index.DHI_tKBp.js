import{g as e,r as t,s,a as o,u as r,d as n,n as a,b as i,c as l,w as c,i as d,o as h,e as u,f as g,h as m,j as p,k as w,l as f}from"./index-D2V8Eyea.js";import{w as C}from"./wallet-manager.DtY3I8Qk.js";import{_ as v}from"./_plugin-vue_export-helper.BCo6x5W8.js";const _=new class{constructor(){this.baseURL="",this.timeout=1e4,this.headers={"Content-Type":"application/json",Accept:"application/json"}}setConfig(e){e.baseURL&&(this.baseURL=e.baseURL),e.timeout&&(this.timeout=e.timeout),e.headers&&(this.headers={...this.headers,...e.headers})}requestInterceptor(t){const s=e("token");return s&&(t.header=t.header||{},t.header.Authorization=`Bearer ${s}`),console.log("请求拦截器:",t),t}responseInterceptor(e){if(console.log("响应拦截器:",e),200===e.statusCode)return e.data;throw 401===e.statusCode?(t("token"),s({title:"登录已过期，请重新登录",icon:"none"}),new Error("登录已过期")):new Error(`请求失败: ${e.statusCode}`)}errorHandler(e){console.error("请求错误:",e);let t="网络请求失败";return e.errMsg&&(t=e.errMsg.includes("timeout")?"请求超时，请检查网络连接":e.errMsg.includes("fail")?"网络连接失败，请检查网络设置":e.errMsg.includes("CORS")||e.errMsg.includes("cross-origin")?"跨域请求被阻止，请联系管理员":e.errMsg),console.warn("请求失败:",t),Promise.reject(e)}request(e){return new Promise(((t,s)=>{const r={url:e.url.startsWith("http")?e.url:`${this.baseURL}${e.url}`,method:e.method||"GET",data:e.data||{},header:{...this.headers,...e.header},timeout:e.timeout||this.timeout,withCredentials:!1,success:e=>{try{const s=this.responseInterceptor(e);t(s)}catch(o){s(o)}},fail:e=>{this.errorHandler(e),s(e)}},n=this.requestInterceptor(r);console.log("发送请求:",n),o(n)}))}get(e,t={},s={}){return this.request({url:e,method:"GET",data:t,...s})}post(e,t={},s={}){return this.request({url:e,method:"POST",data:t,...s})}put(e,t={},s={}){return this.request({url:e,method:"PUT",data:t,...s})}delete(e,t={},s={}){return this.request({url:e,method:"DELETE",data:t,...s})}upload(t,s,o={},n={}){return new Promise(((a,i)=>{const l=e("token"),c={...this.headers};l&&(c.Authorization=`Bearer ${l}`),r({url:t.startsWith("http")?t:`${this.baseURL}${t}`,filePath:s,name:n.name||"file",formData:o,header:c,success:e=>{try{const t=JSON.parse(e.data);a(t)}catch(t){a(e.data)}},fail:e=>{this.errorHandler(e),i(e)}})}))}download(e,t={}){return new Promise(((t,s)=>{n({url:e.startsWith("http")?e:`${this.baseURL}${e}`,success:e=>{200===e.statusCode?t(e):s(new Error(`下载失败: ${e.statusCode}`))},fail:e=>{this.errorHandler(e),s(e)}})}))}},b=""+new URL("register-DESpRqL-.png",import.meta.url).href,L=""+new URL("register1-D4ejf3FA.png",import.meta.url).href;const U=v({data:()=>({walletConnected:!1,loading:!1,inviteCode:"",walletAddress:""}),onLoad(e){console.log("index页面加载",e),this.getInviteCode(e),this.initPage()},methods:{getInviteCode(t){if(t.invite_code)return this.inviteCode=t.invite_code,void console.log("从页面参数获取到邀请码:",this.inviteCode);const s=new URLSearchParams(window.location.search).get("invite_code");if(s)return this.inviteCode=s,void console.log("从URL参数获取到邀请码:",this.inviteCode);const o=e("invite_code");if(o)return this.inviteCode=o,void console.log("从本地存储获取到邀请码:",this.inviteCode);console.log("未找到邀请码")},async initPage(){try{console.log("页面初始化完成"),console.log("当前邀请码:",this.inviteCode)}catch(e){console.error("页面初始化失败:",e)}},async connectWallet(){console.log("点击连接钱包按钮");try{this.loading=!0;const e=await C.connectWallet();if(console.log("钱包连接结果:",e),e.success){if(this.walletConnected=!0,this.walletAddress=e.account||e.address,console.log("获取到的钱包地址:",this.walletAddress),!this.walletAddress)throw new Error("钱包连接成功但未获取到地址");await this.registerUser(),setTimeout((()=>{a({url:"/pages/wallet/wallet",success:()=>{console.log("跳转到钱包页面成功")},fail:e=>{console.error("跳转失败:",e),s({title:"跳转失败",icon:"none"})}})}),1e3)}else s({title:"连接失败: "+e.error,icon:"none"})}catch(e){console.error("连接钱包失败:",e),s({title:"连接失败",icon:"none"})}finally{this.loading=!1}},async registerUser(){try{console.log("开始用户注册..."),console.log("当前账户(钱包地址):",this.walletAddress),console.log("邀请码:",this.inviteCode);const e=await _.post("/api/wanlshop/user/regTP",{username:this.walletAddress,invite_code:this.inviteCode});console.log("用户注册结果:",e.data.userinfo.invite_code),i("invite_code",e.data.userinfo.invite_code)}catch(e){throw console.error("用户注册失败:",e),s({title:"注册失败: "+(e.errMsg||e.message),icon:"none"}),e}}}},[["render",function(e,t,s,o,r,n){const a=p,i=w,C=d,v=f;return h(),l(C,{class:"content"},{default:c((()=>[u(a,{class:"background-image",src:b,mode:"aspectFill"}),u(C,{class:"connect-button-container"},{default:c((()=>[u(i,{class:"connect-button",onClick:n.connectWallet},{default:c((()=>[u(a,{class:"button-image",src:L,mode:"aspectFit"})])),_:1},8,["onClick"])])),_:1}),r.walletConnected?(h(),l(C,{key:0,class:"success-section"},{default:c((()=>[u(C,{class:"success-card"},{default:c((()=>[u(v,{class:"success-title"},{default:c((()=>[g("钱包连接成功！")])),_:1}),u(v,{class:"success-desc"},{default:c((()=>[g("正在跳转到钱包页面...")])),_:1})])),_:1})])),_:1})):m("",!0)])),_:1})}],["__scopeId","data-v-d7bc4bc6"]]);export{U as default};
