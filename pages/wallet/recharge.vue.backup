<template>
	<view class="recharge-page">
		
		<!-- È°∂ÈÉ®ÂØºËà™Ê†?-->
		<NavBar title="ÂÖÖÂÄ? />
		
		<!-- Èí±ÂåÖËøûÊé•Áä∂ÊÄÅÊèêÁ§?-->
		<view v-if="!walletConnected" class="connection-notice">
			<text class="notice-text">Èí±ÂåÖÊú™ËøûÊé?/text>
			<button class="connect-btn" @click="goToConnect">ËøûÊé•Èí±ÂåÖ</button>
		</view>
		
		<!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
		<view class="main-content">
			<!-- ËæìÂÖ•ÊèêÁ§∫ -->
			<view class="input-section">
				<text class="input-label">ËØ∑Â°´ÂÜôÊï∞Èá?/text>
				<view class="amount-input">
					<text class="currency-symbol">$</text>
					<input 
						class="amount-field" 
						type="number" 
						v-model="rechargeAmount" 
						placeholder="0.00"
						@input="onAmountInput"
					/>
				</view>
				<view class="input-line"></view>
			</view>
			
			<!-- ÂΩìÂâç‰ΩôÈ¢ù -->
			<view class="balance-info">
				<text class="balance-text">ÂΩìÂâç‰ΩôÈ¢ù: {{ currentBalance }}</text>
			</view>
			
			<!-- ÊúÄ‰ΩéÈáëÈ¢ùÊèêÁ§?-->
			<view class="min-amount-notice">
				<text class="notice-text">*ÊúÄ‰Ω?0Ëµ?/text>
			</view>
			
			<!-- È¢ÑËÆæÈáëÈ¢ùÊåâÈíÆ -->
			<view class="preset-amounts">
				<view 
					class="preset-btn" 
					v-for="amount in presetAmounts" 
					:key="amount"
					:class="{ active: rechargeAmount == amount }"
					@click="selectPresetAmount(amount)"
				>
					<text class="preset-text">{{ amount }}</text>
				</view>
			</view>
			
			<!-- ÂÖÖÂÄºÊåâÈí?-->
			<view class="recharge-section">
				<image 
					class="recharge-btn" 
					src="../../static/chongzhi.png" 
					@click="handleRecharge" 
					:class="{ disabled: !canRecharge }"
				></image>
			</view>
		</view>
	</view>
</template>

<script>
import NavBar from '../../components/NavBar.vue';
import walletManager from '../../utils/wallet-manager.js';
import { getRechargeContractConfig, getCurrentNetwork } from '../../config/contracts.js';

export default {
	name: 'Recharge',
	components: {
		NavBar
	},
	data() {
		return {
			rechargeAmount: '',
			currentBalance: 0,
			presetAmounts: [10, 30, 50, 100, 200],
			walletConnected: false,
			walletAddress: '',
			contractConfig: null,
			currentNetwork: 'TESTNET'
		}
	},
	computed: {
		canRecharge() {
			const amount = parseFloat(this.rechargeAmount);
			return amount >= 10 && amount > 0 && this.walletConnected;
		}
	},
	onLoad() {
		console.log('ÂÖÖÂÄºÈ°µÈù¢Âä†ËΩ?);
		this.initContractConfig();
		this.checkWalletStatus();
	},
	onShow() {
		console.log('ÂÖÖÂÄºÈ°µÈù¢ÊòæÁ§?);
		this.checkWalletStatus();
	},
	methods: {
		// ÂàùÂßãÂåñÂêàÁ∫¶ÈÖçÁΩ?		initContractConfig() {
			try {
				this.currentNetwork = getCurrentNetwork();
				this.contractConfig = getRechargeContractConfig();
				console.log('ÂêàÁ∫¶ÈÖçÁΩÆÂàùÂßãÂå?', this.contractConfig);
			} catch (error) {
				console.error('ÂàùÂßãÂåñÂêàÁ∫¶ÈÖçÁΩÆÂ§±Ë¥?', error);
				uni.showToast({
					title: 'ÂêàÁ∫¶ÈÖçÁΩÆÂàùÂßãÂåñÂ§±Ë¥?,
					icon: 'none'
				});
			}
		},
		// Ê£ÄÊü•Èí±ÂåÖÁä∂ÊÄ?		async checkWalletStatus() {
			try {
				const networkInfo = await walletManager.getNetworkInfo();
				console.log('ÂÖÖÂÄºÈ°µÈù¢Ê£ÄÊü•Èí±ÂåÖÁä∂ÊÄ?', networkInfo);
				
				if (networkInfo.isConnected && networkInfo.account) {
					this.walletConnected = true;
					this.walletAddress = networkInfo.account;
					// Âä†ËΩΩ‰ΩôÈ¢ù
					await this.loadCurrentBalance();
				} else {
					this.walletConnected = false;
					this.walletAddress = '';
					this.currentBalance = 0;
				}
			} catch (error) {
				console.error('Ê£ÄÊü•Èí±ÂåÖÁä∂ÊÄÅÂ§±Ë¥?', error);
				this.walletConnected = false;
				this.walletAddress = '';
				this.currentBalance = 0;
			}
		},
		
		// Âä†ËΩΩÂΩìÂâç‰ΩôÈ¢ù
		async loadCurrentBalance() {
			try {
				if (!this.walletConnected) {
					this.currentBalance = 0;
					return;
				}
				
				const result = await walletManager.getBalance(this.walletAddress);
				if (result.success) {
					this.currentBalance = result.balance;
					console.log('‰ΩôÈ¢ùÂä†ËΩΩÊàêÂäü:', this.currentBalance);
				} else {
					console.warn('‰ΩôÈ¢ùÂä†ËΩΩÂ§±Ë¥•:', result.error);
					this.currentBalance = 0;
				}
			} catch (error) {
				console.error('Âä†ËΩΩ‰ΩôÈ¢ùÂ§±Ë¥•:', error);
				this.currentBalance = 0;
			}
		},
		
		// ÈÄâÊã©È¢ÑËÆæÈáëÈ¢ù
		selectPresetAmount(amount) {
			this.rechargeAmount = amount.toString();
		},
		
		// ÈáëÈ¢ùËæìÂÖ•Â§ÑÁêÜ
		onAmountInput(e) {
			const value = e.detail.value;
			// ÈôêÂà∂Âè™ËÉΩËæìÂÖ•Êï∞Â≠óÂíåÂ∞èÊï∞ÁÇπ
			this.rechargeAmount = value.replace(/[^\d.]/g, '');
		},
		
		// Â§ÑÁêÜÂÖÖÂÄ?		handleRecharge() {
			if (!this.walletConnected) {
				uni.showToast({
					title: 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ',
					icon: 'none'
				});
				return;
			}
			
			if (!this.canRecharge) {
				uni.showToast({
					title: 'ËØ∑ËæìÂÖ•ÊúâÊïàÈáëÈ¢ùÔºàÊúÄ‰Ω?0Ôº?,
					icon: 'none'
				});
				return;
			}
			
			const amount = parseFloat(this.rechargeAmount);
			uni.showModal({
				title: 'Á°ÆËÆ§ÂÖÖÂÄ?,
				content: `Á°ÆËÆ§ÂÖÖÂÄ?${amount} TRX ÂêóÔºü\n\nÊ≥®ÊÑèÔºöÂÖÖÂÄºÂ∞ÜÈÄöËøáÂå∫ÂùóÈìæ‰∫§ÊòìËøõË°åÔºåËØ∑Á°Æ‰øùÁΩëÁªúÁ®≥ÂÆö„ÄÇ`,
				success: (res) => {
                console.log(res);
					if (res.confirm) {
						this.processRecharge(amount);
					}
				}
			});
		},
		
		// ÊâßË°åÂÖÖÂÄºÔºàÈÄöËøáÊô∫ËÉΩÂêàÁ∫¶Ôº?		async processRecharge(amount) {
			uni.showLoading({
				title: 'ÂÖÖÂÄº‰∏≠...'
			});
			
			try {
				// Ê£ÄÊü•Èí±ÂåÖÊúçÂä°Áä∂ÊÄ?				if (!walletManager.currentService) {
					throw new Error('Èí±ÂåÖÊúçÂä°Êú™ÂàùÂßãÂåñÔºåËØ∑ÈáçÊñ∞ËøûÊé•Èí±ÂåÖ');
				}
				
				// Ê£ÄÊü•Èí±ÂåÖËøûÊé•Áä∂ÊÄ?				const networkInfo = await walletManager.getNetworkInfo();
				if (!networkInfo.isConnected || !networkInfo.account) {
					throw new Error('Èí±ÂåÖÊú™ËøûÊé•ÔºåËØ∑ÂÖàËøûÊé•Èí±ÂåÖ');
				}
				
				// Ê£ÄÊü•ÂêàÁ∫¶ÈÖçÁΩ?				if (!this.contractConfig || !this.contractConfig.address) {
					throw new Error('ÂÖÖÂÄºÂêàÁ∫¶Êú™ÈÖçÁΩÆÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂë?);
				}
				
				console.log('ÂºÄÂßãÂÖÖÂÄºÊµÅÁ®ãÔºåÈáëÈ¢ù:', amount, 'TRX');
				console.log('‰ΩøÁî®ÂêàÁ∫¶:', this.contractConfig.address);
				console.log('ÂΩìÂâçÁΩëÁªú:', this.currentNetwork);
				
				// Ë∞ÉÁî®Êô∫ËÉΩÂêàÁ∫¶ËøõË°åÂÖÖÂÄ?				const result = await this.callRechargeContract(amount);
				
				if (result.success) {
					// ÂÖÖÂÄºÊàêÂä?					uni.hideLoading();
					uni.showToast({
						title: 'ÂÖÖÂÄºÊàêÂä?,
						icon: 'success'
					});
					
					// Ê∏ÖÁ©∫ËæìÂÖ•Ê°?					this.rechargeAmount = '';
					
					// Êõ¥Êñ∞‰ΩôÈ¢ù
					await this.loadCurrentBalance();
					
					// ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
					setTimeout(() => {
						uni.showModal({
							title: 'ÂÖÖÂÄºÊàêÂä?,
							content: `ÊàêÂäüÂÖÖÂÄ?${amount} TRX\n\n‰∫§ÊòìÂìàÂ∏å: ${result.txHash}\n\nÁΩëÁªú: ${this.contractConfig.networkName}\n\n‰ΩôÈ¢ùÂ∑≤Êõ¥Êñ∞`,
							showCancel: false,
							success: () => {
								// ÂèØ‰ª•ÈÄâÊã©ËøîÂõû‰∏ä‰∏ÄÈ°?								// uni.navigateBack();
							}
						});
					}, 1000);
					
				} else {
					throw new Error(result.error || 'ÂÖÖÂÄºÂ§±Ë¥?);
				}
				
			} catch (error) {
				uni.hideLoading();
				uni.showToast({
					title: error.message || 'ÂÖÖÂÄºÂ§±Ë¥•ÔºåËØ∑ÈáçËØ?,
					icon: 'none'
				});
				console.error('ÂÖÖÂÄºÂ§±Ë¥?', error);
			}
		},
		
		// Ë∞ÉÁî®ÂÖÖÂÄºÂêàÁ∫?		async callRechargeContract(amount) {
			try {
				console.log('Ë∞ÉÁî®ÂÖÖÂÄºÂêàÁ∫¶ÂºÄÂß?);
				
				// ÊûÑÂª∫ÂêàÁ∫¶Ë∞ÉÁî®Êï∞ÊçÆ
				const contractData = this.buildContractCallData(amount);
				
				// ÂèëÈÄÅ‰∫§ÊòìÂà∞ÂêàÁ∫¶
				const result = await walletManager.sendTransaction(
					this.contractConfig.address,
					amount * 1000000 // TRXËΩ¨Êç¢‰∏∫sunÂçï‰Ωç
				);
				
				console.log('ÂêàÁ∫¶Ë∞ÉÁî®ÁªìÊûú:', result);
				
				if (result.success) {
					return {
						success: true,
						txHash: result.txId || result.txHash,
						message: 'ÂÖÖÂÄºÂêàÁ∫¶Ë∞ÉÁî®ÊàêÂä?
					};
				} else {
					return {
						success: false,
						error: result.error || 'ÂêàÁ∫¶Ë∞ÉÁî®Â§±Ë¥•'
					};
				}
				
			} catch (error) {
				console.error('Ë∞ÉÁî®ÂÖÖÂÄºÂêàÁ∫¶Â§±Ë¥?', error);
				return {
					success: false,
					error: error.message || 'ÂêàÁ∫¶Ë∞ÉÁî®Â§±Ë¥•'
				};
			}
		},
		
		// ÊûÑÂª∫ÂêàÁ∫¶Ë∞ÉÁî®Êï∞ÊçÆ
		buildContractCallData(amount) {
			try {
				// ËøôÈáåÂ∫îËØ•Ê†πÊçÆÂêàÁ∫¶ABIÊûÑÂª∫Ê≠£Á°ÆÁöÑË∞ÉÁî®Êï∞Êç?				// Áî±‰∫éTRONÁΩëÁªúÁöÑÁâπÊÆäÊÄßÔºåÂèØËÉΩÈúÄË¶Å‰ΩøÁî®tronWebÊàñÂÖ∂‰ªñÊñπÂº?				
				// Á§∫‰æãÔºöÊûÑÂª∫ÂÖÖÂÄºÊñπÊ≥ïÁöÑË∞ÉÁî®Êï∞ÊçÆ
				const methodSignature = 'recharge(uint256)';
				const amountHex = '0x' + (amount * 1000000).toString(16).padStart(64, '0');
				
				console.log('ÊûÑÂª∫ÂêàÁ∫¶Ë∞ÉÁî®Êï∞ÊçÆ:', {
					method: methodSignature,
					amount: amount,
					amountHex: amountHex
				});
				
				return {
					method: methodSignature,
					params: [amountHex]
				};
				
			} catch (error) {
				console.error('ÊûÑÂª∫ÂêàÁ∫¶Ë∞ÉÁî®Êï∞ÊçÆÂ§±Ë¥•:', error);
				throw new Error('ÂêàÁ∫¶Ë∞ÉÁî®Êï∞ÊçÆÊûÑÂª∫Â§±Ë¥•');
			}
		},
		
		// Ë∑≥ËΩ¨Âà∞ËøûÊé•Èí±ÂåÖÈ°µÈù?		goToConnect() {
			// Áõ¥Êé•Âú®ÂΩìÂâçÈ°µÈù¢ËøûÊé•Èí±Âå?			this.connectWallet();
		},
		
		// ËøûÊé•Èí±ÂåÖ
		async connectWallet() {
			console.log('ÂºÄÂßãËøûÊé•Èí±Âå?);
			try {
				uni.showLoading({
					title: 'ËøûÊé•‰∏?..'
				});
				
				// Ë∞ÉËØïÔºöÊ£ÄÊü•Èí±ÂåÖÁÆ°ÁêÜÂô®Áä∂ÊÄ?				console.log('Èí±ÂåÖÁÆ°ÁêÜÂô®Áä∂ÊÄ?', {
					currentService: walletManager.currentService,
					serviceType: walletManager.serviceType,
					isConnected: walletManager.isConnected
				});
				
				const result = await walletManager.connectWallet();
				
				uni.hideLoading();
				
				if (result.success) {
					uni.showToast({
						title: 'Èí±ÂåÖËøûÊé•ÊàêÂäü',
						icon: 'success'
					});
					
					// ÈáçÊñ∞Ê£ÄÊü•Èí±ÂåÖÁä∂ÊÄ?					await this.checkWalletStatus();
					
					// Ë∞ÉËØïÔºöËøûÊé•ÂêéÁöÑÁä∂ÊÄ?					console.log('ËøûÊé•ÂêéÈí±ÂåÖÁÆ°ÁêÜÂô®Áä∂ÊÄ?', {
						currentService: walletManager.currentService,
						serviceType: walletManager.serviceType,
						isConnected: walletManager.isConnected
					});
					
				} else {
					uni.showToast({
						title: result.error || 'ËøûÊé•Â§±Ë¥•',
						icon: 'none'
					});
					
					// Â¶ÇÊûúÊúâÂª∫ËÆÆ‰ø°ÊÅØÔºåÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑÊèêÁ§∫
					if (result.suggestions) {
						setTimeout(() => {
							uni.showModal({
								title: 'ËøûÊé•Â§±Ë¥•',
								content: result.suggestions,
								showCancel: false
							});
						}, 1000);
					}
				}
				
			} catch (error) {
				uni.hideLoading();
				console.error('ËøûÊé•Èí±ÂåÖÂ§±Ë¥•:', error);
				uni.showToast({
					title: 'ËøûÊé•Â§±Ë¥•ÔºåËØ∑ÈáçËØï',
					icon: 'none'
				});
			}
		}
	}
}
</script>

<style scoped>
.recharge-page {
	min-height: 100vh;
	background-image: url('../../static/back.png');
	background-size: cover;
	background-position: center;
	background-repeat: no-repeat;
	color: white;
	font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.main-content {
	padding: 60rpx 40rpx;
}

.input-section {
	margin-bottom: 40rpx;
}

.input-label {
	display: block;
	font-size: 28rpx;
	color: white;
	margin-bottom: 30rpx;
}

.amount-input {
	display: flex;
	align-items: center;
	margin-bottom: 20rpx;
}

.currency-symbol {
	font-size: 48rpx;
	color: white;
	font-weight: bold;
	margin-right: 20rpx;
}

.amount-field {
	flex: 1;
	font-size: 48rpx;
	color: white;
	font-weight: bold;
	background: transparent;
	border: none;
	outline: none;
}

.input-line {
	height: 2rpx;
	background: white;
	width: 100%;
}

.balance-info {
	margin-bottom: 30rpx;
}

.balance-text {
	font-size: 28rpx;
	color: white;
}

.min-amount-notice {
	margin-bottom: 50rpx;
}

.notice-text {
	font-size: 24rpx;
	color: rgba(255, 255, 255, 0.7);
}

.preset-amounts {
	display: flex;
	gap: 20rpx;
	margin-bottom: 60rpx;
	flex-wrap: wrap;
}

.preset-btn {
	background: rgba(0, 0, 0, 0.5);
	border: 2rpx solid #ff6b6b;
	border-radius: 15rpx;
	padding: 20rpx 30rpx;
	position: relative;
	transition: all 0.3s ease;
}

.preset-btn::before {
	content: '';
	position: absolute;
	top: 8rpx;
	right: 8rpx;
	width: 8rpx;
	height: 8rpx;
	background: #ff6b6b;
	border-radius: 50%;
}

.preset-btn.active {
	background: #ff6b6b;
	border-color: #ff6b6b;
}

.preset-text {
	font-size: 28rpx;
	color: white;
	font-weight: bold;
}

.recharge-section {
	display: flex;
	justify-content: center;
}

.recharge-btn {
	width: 400rpx;
	height: 150rpx;
	border-radius: 50%;
	overflow: hidden;
	box-shadow: 0 8rpx 20rpx rgba(255, 107, 107, 0.3);
	transition: all 0.3s ease;
	cursor: pointer;
}

.recharge-btn:active {
	transform: scale(0.95);
}

.recharge-btn.disabled {
	opacity: 0.5;
	filter: grayscale(100%);
	pointer-events: none;
}

.connection-notice {
	background: rgba(255, 107, 107, 0.2);
	border: 1rpx solid rgba(255, 107, 107, 0.5);
	border-radius: 15rpx;
	margin: 20rpx 40rpx;
	padding: 30rpx;
	text-align: center;
	backdrop-filter: blur(10rpx);
}

.notice-text {
	display: block;
	color: #ff6b6b;
	font-size: 26rpx;
	font-weight: bold;
	margin-bottom: 20rpx;
}

.connect-btn {
	background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
	border: none;
	border-radius: 12rpx;
	color: white;
	font-size: 24rpx;
	font-weight: bold;
	padding: 15rpx 30rpx;
	box-shadow: 0 4rpx 12rpx rgba(255, 107, 107, 0.3);
	transition: all 0.3s ease;
}

.connect-btn:active {
	transform: scale(0.95);
	opacity: 0.8;
}
</style>
