// Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ - Ö§ï¿½ï¿½ï¿½ï¿½Ì«ï¿½ï¿½
import walletService from './wallet.js';
import walletH5Service from './wallet-h5.js';

class WalletManager {
  constructor() {
    this.currentService = null;
    this.serviceType = null;
    this.init();
  }

  // ï¿½ï¿½Ê¼ï¿½ï¿½Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
  init() {
    // ï¿½ï¿½ï¿½Ý»ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½ï¿?    if (this.isEthereumEnvironment()) {
      // ï¿½ï¿½Ì«ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½ï¿½ï¿½Ì«ï¿½ï¿½Ç®ï¿½ï¿½
      this.currentService = walletH5Service; // Ê¹ï¿½ï¿½ï¿½ï¿½ï¿½Ðµï¿½H5ï¿½ï¿½ï¿½ñ£¬µï¿½ï¿½Þ¸ï¿½ÎªÖ§ï¿½ï¿½ï¿½ï¿½Ì«ï¿½ï¿½
      this.serviceType = 'Ethereum';
      console.log('Ê¹ï¿½ï¿½ï¿½ï¿½Ì«ï¿½ï¿½Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½');
    } else if (this.isH5Environment()) {
      // H5ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½Web3ï¿½ï¿½Ê½
      this.currentService = walletH5Service;
      this.serviceType = 'H5';
      console.log('Ê¹ï¿½ï¿½H5Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½');
    } else {
      // Appï¿½ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½Ô­ï¿½ï¿½ï¿½ï¿½ï¿½Ã·ï¿½Ê½
      this.currentService = walletService;
      this.serviceType = 'Native';
      console.log('Ê¹ï¿½ï¿½Ô­ï¿½ï¿½Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½');
    }
  }

  // ï¿½ï¿½ï¿½ï¿½Ç·ï¿½Îªï¿½ï¿½Ì«ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?  isEthereumEnvironment() {
    // ï¿½ï¿½ï¿½ï¿½Ç·ï¿½×°ï¿½ï¿½ï¿½ï¿½Ì«ï¿½ï¿½Ç®ï¿½ï¿?    return typeof window !== 'undefined' && window.ethereum;
  }

  // ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ÎªH5ï¿½ï¿½ï¿½ï¿½
  isH5Environment() {
    // #ifdef H5
    return true;
    // #endif
    
    // #ifndef H5
    return false;
    // #endif
  }

  // ï¿½ï¿½È¡ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
  getServiceType() {
    return this.serviceType;
  }

  // ï¿½ï¿½ï¿½TPÇ®ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½ï¿?  async detectTPWallet() {
    try {
      return await this.currentService.detectTPWallet();
    } catch (error) {
      console.error('ï¿½ï¿½ï¿½Ç®ï¿½ï¿½Ê§ï¿½ï¿?', error);
      return false;
    }
  }

  // ï¿½ï¿½ï¿½ï¿½Ç®ï¿½ï¿½
  async connectWallet() {
    try {
      const result = await this.currentService.connectWallet();
      
      // ï¿½ï¿½Â¼ï¿½ï¿½Ï¸ï¿½Ä´ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢
      if (!result.success) {
        console.warn('Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê§ï¿½ï¿½:', result);
      }
      
      return result;
    } catch (error) {
      console.error('ï¿½ï¿½ï¿½ï¿½Ç®ï¿½ï¿½Ê§ï¿½ï¿½:', error);
      
      // ï¿½á¹©ï¿½ÑºÃµÄ´ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢
      let errorMessage = 'ï¿½ï¿½ï¿½ï¿½Ç®ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½Î´Öªï¿½ï¿½ï¿½ï¿½';
      let suggestions = 'ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Óºï¿½Ç®ï¿½ï¿½Ó¦ï¿½ï¿½×´Ì¬';
      
      if (error.message.includes('ï¿½Ã»ï¿½ï¿½Ü¾ï¿½')) {
        errorMessage = 'ï¿½Ã»ï¿½ï¿½Ü¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç®ï¿½ï¿½';
        suggestions = 'ï¿½ï¿½ï¿½ï¿½Ç®ï¿½ï¿½ï¿½Ðµï¿½ï¿?ï¿½ï¿½ï¿½ï¿½"ï¿½ï¿½"È·ï¿½ï¿½"';
      } else if (error.message.includes('Î´ï¿½ï¿½âµ?)) {
        errorMessage = 'Î´ï¿½ï¿½âµ½Ç®ï¿½ï¿?;
        suggestions = 'ï¿½ï¿½È·ï¿½ï¿½ï¿½Ñ°ï¿½×°Ç®ï¿½ï¿½Ó¦ï¿½Ã²ï¿½Ë¢ï¿½ï¿½Ò³ï¿½ï¿½';
      }
      
      return {
        success: false,
        error: errorMessage,
        suggestions: suggestions,
        code: 'CONNECTION_ERROR'
      };
    }
  }

  // ï¿½ï¿½È¡ï¿½Ë»ï¿½ï¿½ï¿½ï¿?  async getBalance(address = null) {
    try {
      const result = await this.currentService.getBalance(address);
      
      // ï¿½ï¿½ï¿½ï¿½ï¿½È¡ï¿½ï¿½ï¿½Ê§ï¿½Ü£ï¿½ï¿½ï¿½ï¿½ï¿½Ä£ï¿½ï¿½Ä£Ê½
      if (!result.success && this.serviceType === 'Native') {
        console.warn('Ô­ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È¡ï¿½ï¿½ï¿½Ê§ï¿½Ü£ï¿½ï¿½ï¿½ï¿½ï¿½Ä£ï¿½ï¿½Ä£Ê½');
        return await this.currentService.mockGetBalance();
      }
      
      return result;
    } catch (error) {
      console.error('ï¿½ï¿½È¡ï¿½ï¿½ï¿½Ê§ï¿½ï¿?', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // ï¿½ï¿½ï¿½Í½ï¿½ï¿½ï¿½
  async sendTransaction(toAddress, amount) {
    try {
      const result = await this.currentService.sendTransaction(toAddress, amount);
      
      return result;
    } catch (error) {
      console.error('ï¿½ï¿½ï¿½Í½ï¿½ï¿½ï¿½Ê§ï¿½ï¿½:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½×´Ì¬
  async getNetworkInfo() {
    try {
      if (!this.currentService) {
        console.warn('Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Î´ï¿½ï¿½Ê¼ï¿½ï¿½');
        return { isConnected: false, account: null, chainId: null };
      }
      
      const networkInfo = this.currentService.getNetworkInfo();
      console.log('Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï?', networkInfo);
      
      return networkInfo;
    } catch (error) {
      console.error('ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢Ê§ï¿½ï¿½:', error);
      return { isConnected: false, account: null, chainId: null };
    }
  }

  // ï¿½Ð»ï¿½ï¿½ï¿½ï¿½ï¿½
  async switchNetwork(chainId) {
    try {
      return await this.currentService.switchNetwork(chainId);
    } catch (error) {
      console.error('ï¿½Ð»ï¿½ï¿½ï¿½ï¿½ï¿½Ê§ï¿½ï¿½:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // ï¿½ï¿½ï¿½Ó´ï¿½ï¿½Òµï¿½Ç®ï¿½ï¿½
  async addToken(tokenAddress, tokenSymbol, tokenDecimals, tokenImage) {
    try {
      return await this.currentService.addToken(tokenAddress, tokenSymbol, tokenDecimals, tokenImage);
    } catch (error) {
      console.error('ï¿½ï¿½ï¿½Ó´ï¿½ï¿½ï¿½Ê§ï¿½ï¿½:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?  async getTokenBalance(tokenAddress, accountAddress) {
    try {
      return await this.currentService.getTokenBalance(tokenAddress, accountAddress);
    } catch (error) {
      console.error('ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê§ï¿½ï¿?', error);
      return {
        success: false,
        error: error.message,
        balance: '0'
      };
    }
  }
  // ï¿½ï¿½È¡USDTï¿½ï¿½ï¿?  async getUSDTBalance(address = null) {
    try {
      const result = await this.currentService.getUSDTBalance(address);
      return result;
    } catch (error) {
      console.error('ï¿½ï¿½È¡USDTï¿½ï¿½ï¿½Ê§ï¿½ï¿?', error);
      return {
        success: false,
        error: (error && error.message) ? error.message : 'ï¿½ï¿½È¡USDTï¿½ï¿½ï¿½Ê§ï¿½ï¿?,
        balance: 0
      };
    }
  }


  // Ç©ï¿½ï¿½ï¿½ï¿½Ï¢
  async signMessage(message) {
    try {
      return await this.currentService.signMessage(message);
    } catch (error) {
      console.error('Ç©ï¿½ï¿½ï¿½ï¿½Ï¢Ê§ï¿½ï¿½:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // ï¿½Ï¿ï¿½Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
  async disconnectWallet() {
    try {
      const result = await this.currentService.disconnectWallet();
      return result;
    } catch (error) {
      console.error('ï¿½Ï¿ï¿½Ç®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê§ï¿½ï¿½:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // Ç®ï¿½ï¿½×´Ì¬ï¿½ï¿½ï¿½ï¿½
  onAccountsChanged(callback) {
    if (this.currentService && typeof this.currentService.onAccountsChanged === 'function') {
      this.currentService.onAccountsChanged(callback);
    }
  }

  onChainChanged(callback) {
    if (this.currentService && typeof this.currentService.onChainChanged === 'function') {
      this.currentService.onChainChanged(callback);
    }
  }

  onConnect(callback) {
    if (this.currentService && typeof this.currentService.onConnect === 'function') {
      this.currentService.onConnect(callback);
    }
  }

  onDisconnect(callback) {
    if (this.currentService && typeof this.currentService.onDisconnect === 'function') {
      this.currentService.onDisconnect(callback);
    }
  }

  // ï¿½ï¿½ï¿½ß·ï¿½ï¿½ï¿½
  formatBalance(balance, decimals = 18) {
    const divisor = Math.pow(10, decimals);
    return (parseFloat(balance) / divisor).toFixed(6);
  }

  formatAddress(address) {
    if (!address) return '';
    return `${address.slice(0, 6)}...`;
  }

  validateAddress(address) {
    // ï¿½ï¿½ï¿½ï¿½ï¿½Äµï¿½Ö·ï¿½ï¿½Ê½ï¿½ï¿½Ö¤
    if (!address || typeof address !== 'string') {
      return false;
    }
    
    // ï¿½ï¿½Ì«ï¿½ï¿½ï¿½ï¿½Ö·ï¿½ï¿½Ê½ï¿½ï¿½Ö¤
    const ethAddressRegex = /^0x[a-fA-F0-9]{40}$/;
    return ethAddressRegex.test(address);
  }

  // ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?  getExplorerUrl(txHash, type = 'tx') {
    const baseUrl = 'https://etherscan.io';
    switch (type) {
      case 'tx':
        return `${baseUrl}/tx/`;
      case 'address':
        return `${baseUrl}/address/`;
      case 'token':
        return `${baseUrl}/token/`;
      default:
        return baseUrl;
    }
  }

  // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
  handleError(error) {
    let userMessage = 'ï¿½ï¿½ï¿½ï¿½Ê§ï¿½Ü£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½';
    
    if (error.code === 4001) {
      userMessage = 'ï¿½Ã»ï¿½È¡ï¿½ï¿½ï¿½Ë²ï¿½ï¿½ï¿½';
    } else if (error.code === -32602) {
      userMessage = 'ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½';
    } else if (error.code === -32603) {
      userMessage = 'ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½';
    } else if (error.message) {
      if (error.message.includes('insufficient funds')) {
        userMessage = 'ï¿½ï¿½î²»ï¿½ï¿?;
      } else if (error.message.includes('gas')) {
        userMessage = 'Gasï¿½ï¿½ï¿½Ã´ï¿½ï¿½ï¿½';
      } else if (error.message.includes('network')) {
        userMessage = 'ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ó´ï¿½ï¿½ï¿½';
      }
    }
    
    return {
      success: false,
      error: userMessage,
      originalError: error
    };
  }
}

const walletManager = new WalletManager();
export default walletManager;

